<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>إدارة السباحين والسباقات</title>
<style>
  :root {
    --primary-color: #05445e;
    --secondary-color: #189ab4;
    --light-color: #d4f1f4;
    --text-color: #333;
    --border-color: #ddd;
    --error-color: #e74c3c;
    --success-color: #2ecc71;
  }

  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f4f6f8;
    color: var(--text-color);
  }

  .container {
    display: flex;
    height: 100vh;
  }

  /* Sidebar */
  .sidebar {
    width: 250px;
    background: var(--primary-color);
    color: white;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  }

  .sidebar h2 {
    text-align: center;
    padding: 20px 10px;
    border-bottom: 1px solid var(--secondary-color);
    margin: 0;
    font-size: 1.5rem;
    background: rgba(0,0,0,0.1);
  }

  .nav-item {
    padding: 15px 20px;
    cursor: pointer;
    border-bottom: 1px solid var(--secondary-color);
    user-select: none;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .nav-item:hover, .nav-item.active {
    background: var(--secondary-color);
    padding-right: 25px;
  }

  /* Content */
  .content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #fff;
    display: flex; /* Added for flex layout */
    flex-direction: column; /* Stack content and action buttons vertically */
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
  }

  .page-header h3 {
    margin: 0;
    color: var(--primary-color);
    font-size: 1.8rem;
  }

  /* Forms */
  .form-container {
    max-width: 800px;
    margin: 0 auto;
    background: #fff;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
  }

  .form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
  }

  .form-group {
    flex: 1;
    margin-bottom: 15px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--primary-color);
  }

  input[type=text],
  input[type=number],
  input[type=date],
  select,
  textarea {
    width: 100%;
    padding: 10px 12px;
    box-sizing: border-box;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: inherit;
    transition: border 0.3s;
  }

  input[type=text]:focus,
  input[type=number]:focus,
  input[type=date]:focus,
  select:focus,
  textarea:focus {
    border-color: var(--secondary-color);
    outline: none;
    box-shadow: 0 0 0 2px rgba(24, 154, 180, 0.2);
  }

  textarea {
    resize: vertical;
    min-height: 80px;
  }

  .btn {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn:hover {
    background: var(--secondary-color);
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: #6c757d;
  }

  .btn-secondary:hover {
    background: #5a6268;
  }

  .btn-danger {
    background: var(--error-color);
  }

  .btn-danger:hover {
    background: #c0392b;
  }

  .btn-success {
    background: var(--success-color);
  }

  .btn-success:hover {
    background: #27ae60;
  }

  .btn-group {
    display: flex;
    gap: 10px;
  }

  /* Tables */
  .table-container {
    overflow-x: auto;
    margin-top: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
    border-radius: 5px;
    flex-grow: 1; /* Allow table container to take available space */
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
  }

  th, td {
    border: 1px solid var(--border-color);
    padding: 8px 15px;
    text-align: center;
    vertical-align: middle;
    cursor: pointer; /* Add cursor to indicate rows are clickable */
  }

  th {
    background: var(--primary-color);
    color: white;
    font-weight: 600;
  }

  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  tr:hover {
    background-color: var(--light-color);
  }

  tr.selected {
    background-color: var(--secondary-color) !important;
    color: white;
  }

  /* Notes column */
  .notes-column {
    max-width: 200px;
    overflow-y: hidden;
    white-space: normal;
    text-align: right;
    direction: rtl;
    position: relative;
  }

  .notes-column .notes-text {
    display: block;
    max-height: 4.5em; /* Approx 3 lines of text */
    overflow: hidden;
  }

  .notes-column.expanded .notes-text {
    max-height: none;
    overflow: visible;
  }

  .show-more-btn {
    background: none;
    border: none;
    color: var(--secondary-color);
    cursor: pointer;
    text-decoration: underline;
    padding: 0;
    font-size: 0.9em;
    margin-top: 5px;
    display: block;
    text-align: center;
    width: 100%;
  }
  .selected .show-more-btn { /* Style for show more button when row is selected */
      color: white;
  }

  /* Global actions section at the bottom */
  .global-actions {
    padding: 15px 0;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: center;
    gap: 20px;
    background: #fff;
    margin-top: auto; /* Push to the bottom */
  }

  /* Search */
  .search-container {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    gap: 15px;
  }

  .search-input {
    padding: 10px 15px;
    width: 300px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 16px;
    flex: 1;
    max-width: 400px;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: #fff;
    padding: 30px;
    border-radius: 5px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
  }

  .modal-title {
    margin: 0;
    color: var(--primary-color);
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #999;
  }

  /* Messages */
  .alert {
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
    display: none;
  }

  .alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  /* Icons */
  .icon {
    width: 20px;
    height: 20px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .container {
      flex-direction: column;
    }

    .sidebar {
      width: 100%;
      height: auto;
    }

    .content {
      padding: 15px;
    }

    .form-row {
      flex-direction: column;
      gap: 0;
    }

    .search-container {
      flex-direction: column;
    }

    .search-input {
      width: 100%;
      max-width: none;
    }

    .notes-column {
      max-width: 150px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <div class="sidebar">
    <h2>نظام إدارة السباحين</h2>
    <div class="nav-item active" data-page="add-swimmer">
      <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
      </svg>
      إضافة سباح
    </div>
    <div class="nav-item" data-page="view-swimmers">
      <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
      عرض السباحين
    </div>
    <div class="nav-item" data-page="add-race">
      <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M13.49 5.48c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.6 13.9l1-4.4 2.1 2v6h2v-7.5l-2.1-2 .6-3c1.3 1.5 3.3 2.5 5.5 2.5v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1l-5.2 2.2v4.7h2v-3.4l1.8-.7-1.6 8.1-4.9-1-.4 2 7 1.4z"/>
      </svg>
      إضافة سباق
    </div>
    <div class="nav-item" data-page="view-races">
      <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        <path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/>
      </svg>
      عرض السباقات
    </div>
  </div>

  <div class="content" id="content-area">
    <div id="add-swimmer" class="page">
      <div class="page-header">
        <h3>إضافة سباح جديد</h3>
      </div>
      <div id="swimmer-alert" class="alert"></div>
      <div class="form-container">
        <form id="form-add-swimmer">
          <div class="form-row">
            <div class="form-group">
              <label for="swimmer-name">الاسم الكامل:</label>
              <input type="text" id="swimmer-name" />
            </div>
            <div class="form-group">
              <label for="swimmer-age">السن:</label>
              <input type="number" id="swimmer-age" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="swimmer-specialty">التخصص:</label>
              <input type="text" id="swimmer-specialty" />
            </div>
            <div class="form-group">
              <label for="swimmer-gender">الجنس:</label>
              <select id="swimmer-gender">
                <option value="">اختر الجنس</option>
                <option value="ذكر">ذكر</option>
                <option value="أنثى">أنثى</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="swimmer-height">الطول (سم):</label>
              <input type="number" id="swimmer-height" />
            </div>
            <div class="form-group">
              <label for="swimmer-weight">الوزن (كجم):</label>
              <input type="number" id="swimmer-weight" />
            </div>
          </div>

          <div class="form-group">
            <label for="swimmer-notes">ملاحظات:</label>
            <textarea id="swimmer-notes" rows="3"></textarea>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn btn-success">
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
              </svg>
              حفظ السباح
            </button>
            <button type="reset" class="btn btn-secondary">
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
              مسح النموذج
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="view-swimmers" class="page" style="display:none;">
      <div class="page-header">
        <h3>قائمة السباحين</h3>
        <div class="search-container">
          <input type="text" id="search-swimmers" placeholder="ابحث عن سباح بالاسم أو التخصص..." class="search-input" />
        </div>
      </div>
      <div id="swimmers-alert" class="alert"></div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>الاسم</th>
              <th>السن</th>
              <th>الجنس</th>
              <th>التخصص</th>
              <th>الطول</th>
              <th>الوزن</th>
              <th>ملاحظات</th>
              </tr>
          </thead>
          <tbody id="swimmers-table-body">
            </tbody>
        </table>
      </div>
      <div class="global-actions" id="swimmer-global-actions" style="display: none;">
        <button id="edit-selected-swimmer" class="btn btn-success" disabled>
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
          </svg>
          تعديل السباح المحدد
        </button>
        <button id="delete-selected-swimmer" class="btn btn-danger" disabled>
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
          </svg>
          حذف السباح المحدد
        </button>
      </div>
    </div>

    <div id="add-race" class="page" style="display:none;">
      <div class="page-header">
        <h3>إضافة سباق جديد</h3>
      </div>
      <div id="race-alert" class="alert"></div>
      <div class="form-container">
        <form id="form-add-race">
          <div class="form-row">
            <div class="form-group">
              <label for="race-name">اسم السباق:</label>
              <input type="text" id="race-name" />
            </div>
            <div class="form-group">
              <label for="race-date">تاريخ السباق:</label>
              <input type="date" id="race-date" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="race-swimmer">السباح المشترك:</label>
              <select id="race-swimmer">
                <option value="">اختر سباح</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="race-place">مكان السباق:</label>
            <input type="text" id="race-place" />
          </div>

          <div class="form-group">
            <label for="race-notes">ملاحظات:</label>
            <textarea id="race-notes" rows="3"></textarea>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn btn-success">
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
              </svg>
              حفظ السباق
            </button>
            <button type="reset" class="btn btn-secondary">
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
              مسح النموذج
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="view-races" class="page" style="display:none;">
      <div class="page-header">
        <h3>قائمة السباقات</h3>
        <div class="search-container">
          <input type="text" id="search-races" placeholder="ابحث عن سباق بالاسم أو السباح..." class="search-input" />
        </div>
      </div>
      <div id="races-alert" class="alert"></div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>اسم السباق</th>
              <th>السباح</th>
              <th>التاريخ</th>
              <th>المكان</th>
              </tr>
          </thead>
          <tbody id="races-table-body">
            </tbody>
        </table>
      </div>
      <div class="global-actions" id="race-global-actions" style="display: none;">
        <button id="edit-selected-race" class="btn btn-success" disabled>
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
          </svg>
          تعديل السباق المحدد
        </button>
        <button id="delete-selected-race" class="btn btn-danger" disabled>
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
          </svg>
          حذف السباق المحدد
        </button>
      </div>
    </div>
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">تأكيد الحذف</h3>
      <button class="close-btn">&times;</button>
    </div>
    <p id="deleteMessage">هل أنت متأكد أنك تريد حذف هذا العنصر؟</p>
    <div class="btn-group" style="justify-content: flex-end; margin-top: 20px;">
      <button id="cancelDelete" class="btn btn-secondary">إلغاء</button>
      <button id="confirmDelete" class="btn btn-danger">حذف</button>
    </div>
  </div>
</div>

<div id="editSwimmerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">تعديل بيانات السباح</h3>
      <button class="close-btn">&times;</button>
    </div>
    <div id="edit-swimmer-alert" class="alert"></div>
    <form id="form-edit-swimmer">
      <input type="hidden" id="edit-swimmer-id">
      <div class="form-row">
        <div class="form-group">
          <label for="edit-swimmer-name">الاسم الكامل:</label>
          <input type="text" id="edit-swimmer-name" />
        </div>
        <div class="form-group">
          <label for="edit-swimmer-age">السن:</label>
          <input type="number" id="edit-swimmer-age" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="edit-swimmer-specialty">التخصص:</label>
          <input type="text" id="edit-swimmer-specialty" />
        </div>
        <div class="form-group">
          <label for="edit-swimmer-gender">الجنس:</label>
          <select id="edit-swimmer-gender">
            <option value="ذكر">ذكر</option>
            <option value="أنثى">أنثى</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="edit-swimmer-height">الطول (سم):</label>
          <input type="number" id="edit-swimmer-height" />
        </div>
        <div class="form-group">
          <label for="edit-swimmer-weight">الوزن (كجم):</label>
          <input type="number" id="edit-swimmer-weight" />
        </div>
      </div>

      <div class="form-group">
        <label for="edit-swimmer-notes">ملاحظات:</label>
        <textarea id="edit-swimmer-notes" rows="3"></textarea>
      </div>

      <div class="btn-group">
        <button type="submit" class="btn btn-success">حفظ التعديلات</button>
        <button type="button" id="cancelEditSwimmer" class="btn btn-secondary">إلغاء</button>
      </div>
    </form>
  </div>
</div>

<div id="editRaceModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">تعديل بيانات السباق</h3>
      <button class="close-btn">&times;</button>
    </div>
    <div id="edit-race-alert" class="alert"></div>
    <form id="form-edit-race">
      <input type="hidden" id="edit-race-id">
      <div class="form-row">
        <div class="form-group">
          <label for="edit-race-name">اسم السباق:</label>
          <input type="text" id="edit-race-name" />
        </div>
        <div class="form-group">
          <label for="edit-race-date">تاريخ السباق:</label>
          <input type="date" id="edit-race-date" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="edit-race-swimmer">السباح المشترك:</label>
          <select id="edit-race-swimmer">
            </select>
        </div>
      </div>

      <div class="form-group">
        <label for="edit-race-place">مكان السباق:</label>
        <input type="text" id="edit-race-place" />
      </div>

      <div class="form-group">
        <label for="edit-race-notes">ملاحظات:</label>
        <textarea id="edit-race-notes" rows="3"></textarea>
      </div>

      <div class="btn-group">
        <button type="submit" class="btn btn-success">حفظ التعديلات</button>
        <button type="button" id="cancelEditRace" class="btn btn-secondary">إلغاء</button>
      </div>
    </form>
  </div>
</div>

<script>
  // صفحات المحتوى
  const pages = document.querySelectorAll('.page');
  const navItems = document.querySelectorAll('.nav-item');

  // متغيرات لتخزين العنصر المحدد
  let selectedSwimmerId = null;
  let selectedRaceId = null;

  function showPage(pageId) {
    pages.forEach(p => {
      p.style.display = p.id === pageId ? 'block' : 'none';
    });
    navItems.forEach(item => {
      item.classList.toggle('active', item.dataset.page === pageId);
    });

    // إظهار/إخفاء الأزرار العامة بناءً على الصفحة النشطة
    const swimmerGlobalActions = document.getElementById('swimmer-global-actions');
    const raceGlobalActions = document.getElementById('race-global-actions');
    if (pageId === 'view-swimmers') {
      swimmerGlobalActions.style.display = 'flex';
      raceGlobalActions.style.display = 'none';
      selectedSwimmerId = null; // Clear selection on page change
      toggleGlobalButtons('swimmer');
      renderSwimmersTable();
    } else if (pageId === 'view-races') {
      swimmerGlobalActions.style.display = 'none';
      raceGlobalActions.style.display = 'flex';
      selectedRaceId = null; // Clear selection on page change
      toggleGlobalButtons('race');
      renderRacesTable();
    } else {
      swimmerGlobalActions.style.display = 'none';
      raceGlobalActions.style.display = 'none';
      selectedSwimmerId = null;
      selectedRaceId = null;
    }

    // إعادة تحميل البيانات عند عرض الصفحة
    if(pageId === 'add-race') {
      populateSwimmersDropdown();
    }
  }

  navItems.forEach(item => {
    item.addEventListener('click', () => showPage(item.dataset.page));
  });

  // عرض رسالة تنبيه
  function showAlert(elementId, message, type = 'success') {
    const alertEl = document.getElementById(elementId);
    alertEl.textContent = message;
    alertEl.className = `alert alert-${type}`;
    alertEl.style.display = 'block';

    setTimeout(() => {
      alertEl.style.display = 'none';
    }, 5000);
  }

  // البيانات في LocalStorage
  function getSwimmers() {
    return JSON.parse(localStorage.getItem('swimmers') || '[]');
  }

  function saveSwimmers(swimmers) {
    localStorage.setItem('swimmers', JSON.stringify(swimmers));
  }

  function getRaces() {
    return JSON.parse(localStorage.getItem('races') || '[]');
  }

  function saveRaces(races) {
    localStorage.setItem('races', JSON.stringify(races));
  }

  // تفعيل/تعطيل الأزرار العامة (تعديل وحذف)
  function toggleGlobalButtons(type) {
    const editButton = document.getElementById(`edit-selected-${type}`);
    const deleteButton = document.getElementById(`delete-selected-${type}`);
    const isSelected = (type === 'swimmer' && selectedSwimmerId !== null) || (type === 'race' && selectedRaceId !== null);
    editButton.disabled = !isSelected;
    deleteButton.disabled = !isSelected;
  }

  // إضافة سباح
  document.getElementById('form-add-swimmer').addEventListener('submit', function(e) {
    e.preventDefault();

    const name = document.getElementById('swimmer-name').value.trim();
    const age = +document.getElementById('swimmer-age').value;
    const specialty = document.getElementById('swimmer-specialty').value.trim();
    const gender = document.getElementById('swimmer-gender').value;
    const height = +document.getElementById('swimmer-height').value;
    const weight = +document.getElementById('swimmer-weight').value;
    const notes = document.getElementById('swimmer-notes').value.trim();

    const swimmers = getSwimmers();
    swimmers.push({
      id: Date.now(),
      name,
      age,
      gender,
      specialty,
      height,
      weight,
      notes
    });
    saveSwimmers(swimmers);

    this.reset();
    showAlert('swimmer-alert', 'تم إضافة السباح بنجاح!', 'success');
    showPage('view-swimmers');
  });

  // عرض السباحين
  const searchSwimmersInput = document.getElementById('search-swimmers');
  searchSwimmersInput.addEventListener('input', renderSwimmersTable);

  function renderSwimmersTable() {
    const swimmers = getSwimmers();
    const searchTerm = searchSwimmersInput.value.trim().toLowerCase();
    const tbody = document.getElementById('swimmers-table-body');
    tbody.innerHTML = '';

    const filtered = swimmers.filter(s =>
      s.name.toLowerCase().includes(searchTerm) ||
      s.specialty.toLowerCase().includes(searchTerm) ||
      (s.notes && s.notes.toLowerCase().includes(searchTerm))
    );

    if(filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7">لا توجد نتائج</td></tr>';
      toggleGlobalButtons('swimmer'); // Disable buttons if no results
      return;
    }

    filtered.forEach(s => {
      const tr = document.createElement('tr');
      tr.dataset.id = s.id; // Store ID on the row
      tr.classList.add('swimmer-row'); // Add a class for easy selection
      const notesContent = s.notes || '---';
      const truncatedNotes = notesContent.length > 50 ? notesContent.substring(0, 50) + '...' : notesContent;
      const showMoreButton = notesContent.length > 50 ? `<button class="show-more-btn" data-fulltext="${notesContent}">عرض المزيد</button>` : '';

      tr.innerHTML = `
        <td>${s.name}</td>
        <td>${s.age || '---'}</td>
        <td>${s.gender || '---'}</td>
        <td>${s.specialty || '---'}</td>
        <td>${s.height ? s.height + ' سم' : '---'}</td>
        <td>${s.weight ? s.weight + ' كجم' : '---'}</td>
        <td class="notes-column">
          <span class="notes-text">${truncatedNotes}</span>
          ${showMoreButton}
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Add click listener to rows for selection
    document.querySelectorAll('.swimmer-row').forEach(row => {
      row.addEventListener('click', () => {
        // Remove 'selected' from previously selected row
        const currentSelected = document.querySelector('.swimmer-row.selected');
        if (currentSelected) {
          currentSelected.classList.remove('selected');
        }
        // Add 'selected' to clicked row
        row.classList.add('selected');
        selectedSwimmerId = row.dataset.id;
        toggleGlobalButtons('swimmer');
      });
    });

    document.querySelectorAll('.show-more-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent row selection when clicking show more
        const notesColumn = e.target.closest('.notes-column');
        const notesText = notesColumn.querySelector('.notes-text');
        const fullText = e.target.dataset.fulltext;

        if (notesColumn.classList.contains('expanded')) {
          notesColumn.classList.remove('expanded');
          notesText.textContent = fullText.substring(0, 50) + '...';
          e.target.textContent = 'عرض المزيد';
        } else {
          notesColumn.classList.add('expanded');
          notesText.textContent = fullText;
          e.target.textContent = 'عرض أقل';
        }
      });
    });

    toggleGlobalButtons('swimmer'); // Update button state after rendering
  }

  function populateSwimmersDropdown(selectId = 'race-swimmer', selectedId = null) {
    const swimmers = getSwimmers();
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">اختر سباح</option>';

    if(swimmers.length === 0) {
      select.innerHTML = '<option value="">لا يوجد سباحين</option>';
      return;
    }

    swimmers.forEach(s => {
      const option = document.createElement('option');
      option.value = s.id;
      option.textContent = s.name;
      option.selected = selectedId == s.id;
      select.appendChild(option);
    });
  }

  document.getElementById('form-add-race').addEventListener('submit', function(e) {
    e.preventDefault();
    const raceName = document.getElementById('race-name').value.trim();
    const swimmerId = document.getElementById('race-swimmer').value;
    const raceDate = document.getElementById('race-date').value;
    const racePlace = document.getElementById('race-place').value.trim();
    const raceNotes = document.getElementById('race-notes').value.trim();

    const swimmers = getSwimmers();
    const swimmer = swimmers.find(s => s.id == swimmerId);

    const races = getRaces();
    races.push({
      id: Date.now(),
      raceName,
      swimmerId,
      swimmerName: swimmer ? swimmer.name : 'غير محدد',
      raceDate,
      racePlace,
      raceNotes
    });
    saveRaces(races);

    this.reset();
    showAlert('race-alert', 'تم إضافة السباق بنجاح!', 'success');
    showPage('view-races');
  });

  const searchRacesInput = document.getElementById('search-races');
  searchRacesInput.addEventListener('input', renderRacesTable);

  function renderRacesTable() {
    const races = getRaces();
    const searchTerm = searchRacesInput.value.trim().toLowerCase();
    const tbody = document.getElementById('races-table-body');
    tbody.innerHTML = '';

    const filtered = races.filter(r =>
      r.raceName.toLowerCase().includes(searchTerm) ||
      r.swimmerName.toLowerCase().includes(searchTerm) ||
      (r.raceNotes && r.raceNotes.toLowerCase().includes(searchTerm))
    );

    if(filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4">لا توجد نتائج</td></tr>';
      toggleGlobalButtons('race'); // Disable buttons if no results
      return;
    }

    filtered.forEach(r => {
      const tr = document.createElement('tr');
      tr.dataset.id = r.id; // Store ID on the row
      tr.classList.add('race-row'); // Add a class for easy selection
      tr.innerHTML = `
        <td>${r.raceName || '---'}</td>
        <td>${r.swimmerName || '---'}</td>
        <td>${r.raceDate || '---'}</td>
        <td>${r.racePlace || '---'}</td>
      `;
      tbody.appendChild(tr);
    });

    // Add click listener to rows for selection
    document.querySelectorAll('.race-row').forEach(row => {
      row.addEventListener('click', () => {
        // Remove 'selected' from previously selected row
        const currentSelected = document.querySelector('.race-row.selected');
        if (currentSelected) {
          currentSelected.classList.remove('selected');
        }
        // Add 'selected' to clicked row
        row.classList.add('selected');
        selectedRaceId = row.dataset.id;
        toggleGlobalButtons('race');
      });
    });

    toggleGlobalButtons('race'); // Update button state after rendering
  }

  const deleteModal = document.getElementById('deleteModal');
  const deleteMessage = document.getElementById('deleteMessage');
  const confirmDeleteBtn = document.getElementById('confirmDelete');
  const cancelDeleteBtn = document.getElementById('cancelDelete');

  let currentDeleteType = null;
  let currentDeleteId = null;

  function confirmDelete(type) { // Removed 'id' parameter
    currentDeleteType = type;
    currentDeleteId = (type === 'swimmer') ? selectedSwimmerId : selectedRaceId;

    if (!currentDeleteId) {
      showAlert(`${type}s-alert`, `الرجاء تحديد ${type === 'swimmer' ? 'سباح' : 'سباق'} للحذف.`, 'error');
      return;
    }

    if(type === 'swimmer') {
      const swimmers = getSwimmers();
      const swimmer = swimmers.find(s => s.id == currentDeleteId);
      deleteMessage.textContent = `هل أنت متأكد أنك تريد حذف السباح "${swimmer.name || 'هذا السباح'}"؟`;
    } else {
      const races = getRaces();
      const race = races.find(r => r.id == currentDeleteId);
      deleteMessage.textContent = `هل أنت متأكد أنك تريد حذف السباق "${race.raceName || 'هذا السباق'}"؟`;
    }

    deleteModal.style.display = 'flex';
  }

  confirmDeleteBtn.addEventListener('click', () => {
    if(currentDeleteType === 'swimmer') {
      const swimmers = getSwimmers();
      const updatedSwimmers = swimmers.filter(s => s.id != currentDeleteId);
      saveSwimmers(updatedSwimmers);

      const races = getRaces();
      // Also remove races associated with the deleted swimmer
      const updatedRaces = races.filter(r => r.swimmerId != currentDeleteId);
      saveRaces(updatedRaces);

      showAlert('swimmers-alert', 'تم حذف السباح بنجاح', 'success');
      selectedSwimmerId = null; // Clear selection
      renderSwimmersTable();
    } else {
      const races = getRaces();
      const updatedRaces = races.filter(r => r.id != currentDeleteId);
      saveRaces(updatedRaces);

      showAlert('races-alert', 'تم حذف السباق بنجاح', 'success');
      selectedRaceId = null; // Clear selection
      renderRacesTable();
    }

    deleteModal.style.display = 'none';
    toggleGlobalButtons(currentDeleteType); // Update button state
  });

  cancelDeleteBtn.addEventListener('click', () => {
    deleteModal.style.display = 'none';
  });

  document.querySelectorAll('.close-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      deleteModal.style.display = 'none';
      editSwimmerModal.style.display = 'none';
      editRaceModal.style.display = 'none';
    });
  });

  const editSwimmerModal = document.getElementById('editSwimmerModal');
  const cancelEditSwimmerBtn = document.getElementById('cancelEditSwimmer');

  function editSwimmer() { // Removed 'id' parameter
    if (!selectedSwimmerId) {
      showAlert('swimmers-alert', 'الرجاء تحديد سباح للتعديل.', 'error');
      return;
    }
    const swimmers = getSwimmers();
    const swimmer = swimmers.find(s => s.id == selectedSwimmerId);

    if(!swimmer) {
      showAlert('swimmers-alert', 'السباح غير موجود', 'error');
      selectedSwimmerId = null; // Clear invalid selection
      toggleGlobalButtons('swimmer');
      return;
    }

    document.getElementById('edit-swimmer-id').value = swimmer.id;
    document.getElementById('edit-swimmer-name').value = swimmer.name || '';
    document.getElementById('edit-swimmer-age').value = swimmer.age || '';
    document.getElementById('edit-swimmer-gender').value = swimmer.gender || '';
    document.getElementById('edit-swimmer-specialty').value = swimmer.specialty || '';
    document.getElementById('edit-swimmer-height').value = swimmer.height || '';
    document.getElementById('edit-swimmer-weight').value = swimmer.weight || '';
    document.getElementById('edit-swimmer-notes').value = swimmer.notes || '';

    editSwimmerModal.style.display = 'flex';
  }

  document.getElementById('form-edit-swimmer').addEventListener('submit', function(e) {
    e.preventDefault();

    const id = +document.getElementById('edit-swimmer-id').value;
    const name = document.getElementById('edit-swimmer-name').value.trim();
    const age = +document.getElementById('edit-swimmer-age').value;
    const gender = document.getElementById('edit-swimmer-gender').value;
    const specialty = document.getElementById('edit-swimmer-specialty').value.trim();
    const height = +document.getElementById('edit-swimmer-height').value;
    const weight = +document.getElementById('edit-swimmer-weight').value;
    const notes = document.getElementById('edit-swimmer-notes').value.trim();

    const swimmers = getSwimmers();
    const swimmerIndex = swimmers.findIndex(s => s.id == id);

    if(swimmerIndex === -1) {
      showAlert('edit-swimmer-alert', 'السباح غير موجود', 'error');
      return;
    }

    swimmers[swimmerIndex] = {
      id,
      name,
      age: age || null,
      gender,
      specialty,
      height: height || null,
      weight: weight || null,
      notes
    };

    saveSwimmers(swimmers);
    editSwimmerModal.style.display = 'none';
    showAlert('swimmers-alert', 'تم تحديث بيانات السباح بنجاح', 'success');
    selectedSwimmerId = null; // Clear selection
    renderSwimmersTable();
    toggleGlobalButtons('swimmer');
  });

  cancelEditSwimmerBtn.addEventListener('click', () => {
    editSwimmerModal.style.display = 'none';
  });

  const editRaceModal = document.getElementById('editRaceModal');
  const cancelEditRaceBtn = document.getElementById('cancelEditRace');

  function editRace() { // Removed 'id' parameter
    if (!selectedRaceId) {
      showAlert('races-alert', 'الرجاء تحديد سباق للتعديل.', 'error');
      return;
    }
    const races = getRaces();
    const race = races.find(r => r.id == selectedRaceId);

    if(!race) {
      showAlert('races-alert', 'السباق غير موجود', 'error');
      selectedRaceId = null; // Clear invalid selection
      toggleGlobalButtons('race');
      return;
    }

    document.getElementById('edit-race-id').value = race.id;
    document.getElementById('edit-race-name').value = race.raceName || '';
    document.getElementById('edit-race-date').value = race.raceDate || '';
    document.getElementById('edit-race-place').value = race.racePlace || '';
    document.getElementById('edit-race-notes').value = race.raceNotes || '';

    populateSwimmersDropdown('edit-race-swimmer', race.swimmerId);

    editRaceModal.style.display = 'flex';
  }

  document.getElementById('form-edit-race').addEventListener('submit', function(e) {
    e.preventDefault();

    const id = +document.getElementById('edit-race-id').value;
    const raceName = document.getElementById('edit-race-name').value.trim();
    const swimmerId = document.getElementById('edit-race-swimmer').value;
    const raceDate = document.getElementById('edit-race-date').value;
    const racePlace = document.getElementById('edit-race-place').value.trim();
    const raceNotes = document.getElementById('edit-race-notes').value.trim();

    const races = getRaces();
    const raceIndex = races.findIndex(r => r.id == id);

    if(raceIndex === -1) {
      showAlert('edit-race-alert', 'السباق غير موجود', 'error');
      return;
    }

    const swimmers = getSwimmers();
    const swimmer = swimmers.find(s => s.id == swimmerId);

    races[raceIndex] = {
      id,
      raceName,
      swimmerId,
      swimmerName: swimmer ? swimmer.name : 'غير محدد',
      raceDate,
      racePlace,
      raceNotes
    };

    saveRaces(races);
    editRaceModal.style.display = 'none';
    showAlert('races-alert', 'تم تحديث بيانات السباق بنجاح', 'success');
    selectedRaceId = null; // Clear selection
    renderRacesTable();
    toggleGlobalButtons('race');
  });

  cancelEditRaceBtn.addEventListener('click', () => {
    editRaceModal.style.display = 'none';
  });

  // إضافة معالجين لحدث النقر على الأزرار العامة
  document.getElementById('edit-selected-swimmer').addEventListener('click', editSwimmer);
  document.getElementById('delete-selected-swimmer').addEventListener('click', () => confirmDelete('swimmer'));
  document.getElementById('edit-selected-race').addEventListener('click', editRace);
  document.getElementById('delete-selected-race').addEventListener('click', () => confirmDelete('race'));

  // افتح صفحة إضافة سباح أول ما تحمل الصفحة
  showPage('add-swimmer');
</script>

</body>
</html>